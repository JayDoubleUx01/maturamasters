{% extends "base.html" %}

{% block content %}
<h2>Dodaj zadanie</h2>

<form method="post" enctype="multipart/form-data">

    <label>Przedmiot</label>
    <select name="przedmiot" id="przedmiot" required>
        <option value="">-- wybierz przedmiot --</option>
        {% for p in przedmioty %}
        <option value="{{ p }}">{{ p|capitalize }}</option>
        {% endfor %}
    </select>

    <label>Zakres</label>
    <select name="zakres" required>
        <option value="">-- wybierz zakres --</option>
        {% for z in zakresy %}
        <option value="{{ z }}">{{ z|capitalize }}</option>
        {% endfor %}
    </select>

    <label>Dzia≈Ç</label>
    <select name="dzial" id="dzial" required>
        <option value="">-- wybierz dzia≈Ç --</option>
    </select>

    <label>Rodzaj arkusza</label>
    <select name="rodzaj_arkusza" id="rodzaj_arkusza" required>
        <option value="" disabled selected>-- wybierz rodzaj arkusza --</option>
        <option value="matura">Matura</option>
        <option value="dodatkowa">Matura dodatkowa</option>
        <option value="poprawkowa">Matura poprawkowa</option>
        <option value="probna">Matura pr√≥bna</option>
        <option value="out">Zadanie spoza arkusza</option>
    </select>

    <div id="arkusz-fields">
        <label>Rok arkusza</label>
        <input type="number" name="rok_arkusza" id="rok_arkusza">

        <label>Numer zadania</label>
        <input type="number" name="numer_zadania" id="numer_zadania">
    </div>

    <label>Typ zadania</label>
    <select name="typ_zadania">
        <option value="zamkniete">Zamkniƒôte</option>
        <option value="otwarte">Otwarte</option>
    </select>

    <!-- üß† EDYTOR MATEMATYCZNY -->
    <label>Tre≈õƒá</label>

    <div class="math-toolbar" id="math-toolbar">

        <!-- OPERATORY -->
        <button type="button" onclick="ins('+')">+</button>
        <button type="button" onclick="ins('-')">‚àí</button>
        <button type="button" onclick="ins('\\cdot')">‚ãÖ</button>
        <button type="button" onclick="ins('\\div')">√∑</button>

        <br>

        <button type="button" onclick="ins('(')">(</button>
        <button type="button" onclick="ins(')')">)</button>
        <button type="button" onclick="ins('‚ü®')">‚ü®</button>
        <button type="button" onclick="ins('‚ü©')">‚ü©</button>
        <button type="button" onclick="ins('[')">[</button>
        <button type="button" onclick="ins(']')">]</button>

        <br>

        <!-- RELACJE -->
        <button type="button" onclick="ins('\\leq')">‚â§</button>
        <button type="button" onclick="ins('\\geq')">‚â•</button>
        <button type="button" onclick="ins('\\neq')">‚â†</button>

        <br>

        <!-- STRUKTURY -->
        <button type="button" onclick="ins('\\sqrt{}')">‚àö</button>
        <button type="button" onclick="ins('\\frac{}{}')">a/b</button>
        <button type="button" onclick="ins('^{}')">x¬≤</button>
        <button type="button" onclick="ins('_{}')">x‚ÇÅ</button>

        <br>

        <!-- SYMBOLE -->
        <button type="button" onclick="ins('\\pi')">œÄ</button>
        <button type="button" onclick="ins('\\infty')">‚àû</button>
        <button type="button" onclick="ins('\\in')">‚àà</button>
        <button type="button" onclick="ins('\\subset')">‚äÇ</button>

    </div>

    <textarea name="tresc" required></textarea>

    <!-- üëÅ PODGLƒÑD -->
    <h4>PodglƒÖd zadania</h4>
    <div id="math-preview" class="task-content"></div>

    <h3>Za≈ÇƒÖczniki</h3>
    <input type="file" name="zalacznik" id="fileInput" accept="image/*">

    <div id="image-preview" style="margin-top:10px;"></div>

    <div id="answers-section">
        <h3>Odpowiedzi (tylko zamkniƒôte)</h3>
        <input type="text" name="odp_a" placeholder="A">
        <input type="text" name="odp_b" placeholder="B">
        <input type="text" name="odp_c" placeholder="C">
        <input type="text" name="odp_d" placeholder="D">
        <input type="text" name="poprawna_odp" placeholder="Poprawna (A-D)">
    </div>

    <button type="submit">Zapisz</button>
</form>

<script>
    const DZIALY = {{ dzialy_przedmiotow | tojson }};

    document.getElementById('przedmiot').addEventListener('change', e => {
        const dzial = document.getElementById('dzial');
        dzial.innerHTML = '<option value="">-- wybierz dzia≈Ç --</option>';
        (DZIALY[e.target.value] || []).forEach(d => {
            dzial.innerHTML += `<option value="${d}">${d}</option>`;
        });
    });

    document.getElementById('rodzaj_arkusza').addEventListener('change', e => {
        const show = e.target.value !== 'out';
        document.getElementById('arkusz-fields').style.display = show ? 'block' : 'none';
    });

    function ins(txt) {
        const t = document.querySelector('textarea[name="tresc"]');
        const s = t.selectionStart;
        t.setRangeText(txt, s, t.selectionEnd, 'end');

        if (txt.includes('{}')) {
            const pos = s + txt.indexOf('{}') + 1;
            t.setSelectionRange(pos, pos);
        }
        t.focus();
    }

    const textarea = document.querySelector('textarea[name="tresc"]');
    const preview = document.getElementById('math-preview');

    textarea.addEventListener('input', () => {
        preview.textContent = textarea.value;
        MathJax.typesetPromise([preview]);
    });

        const przedmiotSelect = document.getElementById('przedmiot');
    const mathToolbar = document.getElementById('math-toolbar');

    function updateMathToolbar() {
        if (przedmiotSelect.value === 'matematyka') {
            mathToolbar.style.display = 'block';
        } else {
            mathToolbar.style.display = 'none';
        }
    }

    przedmiotSelect.addEventListener('change', updateMathToolbar);
    updateMathToolbar();

    document.addEventListener('paste', function (e) {
    const el = document.activeElement;

    // reaguj tylko w textarea tre≈õci
    if (!el || el.tagName !== 'TEXTAREA' || el.name !== 'tresc') {
        return;
    }

    const clipboard = e.clipboardData || window.clipboardData;
    if (!clipboard || !clipboard.items) return;

    for (let i = 0; i < clipboard.items.length; i++) {
        const item = clipboard.items[i];

        if (item.type.indexOf('image') !== -1) {
            const file = item.getAsFile();
            if (!file) return;

            const fileInput = document.getElementById('fileInput');
            const preview = document.getElementById('image-preview');
            if (!fileInput || !preview) return;

            // wstawiamy plik do input[type=file]
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;

            // üëâ PREVIEW OBRAZKA
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = '300px';
            img.style.display = 'block';
            img.style.marginTop = '10px';
            preview.appendChild(img);

            e.preventDefault();
            break;
        }
    }
});
</script>
{% endblock %}
